<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª - ØªÙƒØ§ Ø¨Ù„ÙŠØª</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ... (ÙƒÙ„ Ø§Ù„Ù€ style Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ) ... */
    </style>
</head>
<body>

    <div id="password-prompt">
       </div>

    <div id="dashboard-content">
       <p class="footer-credit">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·ØªÙŠ</p>
    </div>

    <a href="https://wa.me/201207384245" class="whatsapp-support" target="_blank" rel="noopener noreferrer">
        ğŸ—¨ï¸ Ø¯Ø¹Ù… ÙÙ†ÙŠ
    </a>

    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            // ... (ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ) ...
            const notificationSound = document.getElementById('notification-sound'); // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ø±Ø³

            // --- State ---
            let displayedOrderIds = new Set(); // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ Ø§Ù„Ø¬Ø±Ø³ Ø±Ù† Ø¹Ø´Ø§Ù†Ù‡Ø§
            let sessionPassword = '';
            let fetchInterval;

            // --- Event Listeners ---
            // ... (ÙƒÙ„ Ø§Ù„Ù€ Listeners Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ) ...

            // --- Functions ---
            // ... (showNewOrdersView, showArchiveView, handleCompleteButtonClick, main, markOrderAsCompleted, createOrderCard Ø²ÙŠ Ù…Ø§ Ù‡Ù…Ø§) ...

            async function fetchAndRenderOrders(password) {
                try {
                    // ... (Ø¨Ø¯Ø§ÙŠØ© Ø¯Ø§Ù„Ø© fetch Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ) ...
                    const response = await fetch('/api/get-orders', { headers: { 'Authorization': password } });
                    // ... (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„Ø®Ø·Ø£) ...
                    const orders = await response.json();
                    // ... (ØªØ¹Ø±ÙŠÙ newOrdersGrid, archiveGrid, Ø¥Ù„Ø®) ...

                    let newOrdersCount = 0;
                    let archiveCount = 0;
                    let newOrderFound = false; // Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù„Ùˆ ÙÙŠÙ‡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¸Ù‡Ø± ÙˆÙ„Ø§ Ù„Ø£

                    if (!Array.isArray(orders)) { throw new Error("Invalid data received."); }

                    for(const order of orders) {
                        if (!order || !order.InvoiceID) continue;

                        const card = createOrderCard(order);
                        if (!order.Delivered) {
                            newOrdersGrid.appendChild(card);
                            newOrdersCount++;
                            // <<< Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø±Ø³ >>>
                            // Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¯Ù‡ Ø¬Ø¯ÙŠØ¯ (Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)ØŸ
                            // ÙˆÙ‡Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ Ø¨ØªØ§Ø¹Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØµØ§Ù„Ø­ØŸ
                            if (order.rowId !== undefined && order.rowId !== null && !displayedOrderIds.has(order.rowId)) {
                                newOrderFound = true; // Ù„Ù‚ÙŠÙ†Ø§ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙŠØ³ØªØ§Ù‡Ù„ Ø±Ù†Ø© Ø¬Ø±Ø³
                                displayedOrderIds.add(order.rowId); // Ù†Ø³Ø¬Ù„Ù‡ Ø¹Ø´Ø§Ù† Ù…Ø±Ù†Ø´ ØªØ§Ù†ÙŠ Ø¹Ø´Ø§Ù†Ù‡
                            }
                            // <<< Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ >>>
                        } else {
                            archiveGrid.appendChild(card);
                            archiveCount++;
                        }
                    }

                    // ... (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª") ...

                    // <<< Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø±Ø³ Ù„Ùˆ Ù„Ù‚ÙŠÙ†Ø§ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ >>>
                    if (newOrderFound && document.hidden === false) { // Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ§ØªØ­ Ø§Ù„ØµÙØ­Ø©
                         // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù‚Ø¯ ØªÙØ´Ù„ Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹Ù‡Ø§)
                         notificationSound.play().catch(e => {
                            console.warn("Audio play failed, likely due to browser restrictions. User interaction might be required.", e);
                            // Ù…Ù…ÙƒÙ† ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ ØªØ·Ù„Ø¨ Ù…Ù†Ù‡ ÙŠØ¶ØºØ· Ø£ÙŠ Ø²Ø±Ø§Ø± Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØª ÙŠØ´ØªØºÙ„
                         });
                    }
                    // <<< Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ >>>

                    return { success: true, orders: orders };
                } catch (error) {
                    console.error('Failed to fetch orders:', error);
                    return { success: false, error: error.message };
                }
            }
             // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ) ---
            async function main() { /* ... */ }
            async function markOrderAsCompleted(invoiceId) { /* ... */ }
            function createOrderCard(order) { /* ... */ }
             function showNewOrdersView() { /* ... */ }
             function showArchiveView() { /* ... */ }

        }); // End DOMContentLoaded
    </script>
</body>
</html>
