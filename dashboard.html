<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الطلبات - تكا بليت</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ... (كل الـ style زي ما هو) ... */
    </style>
</head>
<body>

    <div id="password-prompt">
       </div>

    <div id="dashboard-content">
       <p class="footer-credit">تم التطوير بواسطتي</p>
    </div>

    <a href="https://wa.me/201207384245" class="whatsapp-support" target="_blank" rel="noopener noreferrer">
        🗨️ دعم فني
    </a>

    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            // ... (كل العناصر زي ما هي) ...
            const notificationSound = document.getElementById('notification-sound'); // تعريف الجرس

            // --- State ---
            let displayedOrderIds = new Set(); // لتتبع الطلبات اللي الجرس رن عشانها
            let sessionPassword = '';
            let fetchInterval;

            // --- Event Listeners ---
            // ... (كل الـ Listeners زي ما هي) ...

            // --- Functions ---
            // ... (showNewOrdersView, showArchiveView, handleCompleteButtonClick, main, markOrderAsCompleted, createOrderCard زي ما هما) ...

            async function fetchAndRenderOrders(password) {
                try {
                    // ... (بداية دالة fetch زي ما هي) ...
                    const response = await fetch('/api/get-orders', { headers: { 'Authorization': password } });
                    // ... (التحقق من كلمة المرور والخطأ) ...
                    const orders = await response.json();
                    // ... (تعريف newOrdersGrid, archiveGrid, إلخ) ...

                    let newOrdersCount = 0;
                    let archiveCount = 0;
                    let newOrderFound = false; // عشان نعرف لو فيه طلب جديد ظهر ولا لأ

                    if (!Array.isArray(orders)) { throw new Error("Invalid data received."); }

                    for(const order of orders) {
                        if (!order || !order.InvoiceID) continue;

                        const card = createOrderCard(order);
                        if (!order.Delivered) {
                            newOrdersGrid.appendChild(card);
                            newOrdersCount++;
                            // <<< بداية التعديل: التحقق قبل تشغيل الجرس >>>
                            // هل الطلب ده جديد (مش موجود في القائمة القديمة)؟
                            // وهل رقم الصف بتاعه موجود وصالح؟
                            if (order.rowId !== undefined && order.rowId !== null && !displayedOrderIds.has(order.rowId)) {
                                newOrderFound = true; // لقينا طلب جديد يستاهل رنة جرس
                                displayedOrderIds.add(order.rowId); // نسجله عشان مرنش تاني عشانه
                            }
                            // <<< نهاية التعديل >>>
                        } else {
                            archiveGrid.appendChild(card);
                            archiveCount++;
                        }
                    }

                    // ... (تحديث الأعداد وعرض رسائل "لا توجد طلبات") ...

                    // <<< بداية التعديل: تشغيل الجرس لو لقينا طلب جديد >>>
                    if (newOrderFound && document.hidden === false) { // نتأكد إن المستخدم فاتح الصفحة
                         // محاولة تشغيل الصوت (قد تفشل لو المتصفح منعها)
                         notificationSound.play().catch(e => {
                            console.warn("Audio play failed, likely due to browser restrictions. User interaction might be required.", e);
                            // ممكن تظهر رسالة للمستخدم هنا تطلب منه يضغط أي زرار عشان الصوت يشتغل
                         });
                    }
                    // <<< نهاية التعديل >>>

                    return { success: true, orders: orders };
                } catch (error) {
                    console.error('Failed to fetch orders:', error);
                    return { success: false, error: error.message };
                }
            }
             // --- باقي الدوال المساعدة (زي ما هي) ---
            async function main() { /* ... */ }
            async function markOrderAsCompleted(invoiceId) { /* ... */ }
            function createOrderCard(order) { /* ... */ }
             function showNewOrdersView() { /* ... */ }
             function showArchiveView() { /* ... */ }

        }); // End DOMContentLoaded
    </script>
</body>
</html>
